<!doctype html><html lang=en><head><title>Synchronous vs Asynchronous Ping Sweep in C# Windows Form</title>
<meta property="og:image" content="https://justinmklam.com//posts/2018/02/ping-sweeper/banner2.PNG"><meta property="og:type" content="blog"><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Life is better when you live asynchronously."><meta name=author content="Justin Lam"><link rel=stylesheet href=https://justinmklam.com/css/syntax.min.css media=screen><link rel=stylesheet href=https://justinmklam.com/css/syntax-dark.min.css media="screen and (prefers-color-scheme: dark)"><link rel=stylesheet href=https://justinmklam.com/css/styles.min.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-85178257-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-85178257-1")</script></head><body><div class="navbar row"><div><span class=navbar-brand>Justin Lam</span></div><div class=navbar-links><a href=/>Blog</a>
<a href=/archives/>Archives</a>
<a href=/about/>About</a>
<a href=/contact/>Contact</a></div></div><div><div class=single-content><h2 data-toc-skip class=blog-title>Synchronous vs Asynchronous Ping Sweep in C# Windows Form</h2><p class=blog-title-metadata>Posted on February 9, 2018
&nbsp;&#183;&nbsp;8 min read
&nbsp;&#183;&nbsp;
<span class=disqus-comment-count data-disqus-url=https://justinmklam.com/posts/2018/02/ping-sweeper/#disqus_thread>0 comments</span>
&nbsp;&#183;&nbsp;
<a class=blog-tag href=/tags/programming>#programming&nbsp;</a></p><a href=/posts/2018/02/ping-sweeper/banner2.PNG><img class="img-content img-content-header" src=/posts/2018/02/ping-sweeper/banner2.PNG></a><details class=toc><summary>&nbsp;Table of Contents</summary><nav id=TableOfContents><ul><li><a href=#the-development>The Development</a><ul><li><a href=#first-attempt-some-ping-simple>First Attempt: Some-ping Simple</a></li><li><a href=#second-attempt-jaime-lan-nister-pingslayer>Second Attempt: Jaime LAN-nister, Pingslayer</a><ul><li><a href=#digging-deeper-a-battle-of-asynchronous-pings>Digging Deeper: A Battle of Asynchronous Pings</a></li><li><a href=#digging-deeper-background-worker-vs-asyncawait>Digging Deeper: Background Worker vs Async/Await</a></li></ul></li><li><a href=#third-attempt-one-ping-to-rule-them-all-one-ping-to-find-them>Third Attempt: One Ping to Rule Them All, One Ping to Find Them</a><ul><li><a href=#verification-with-benchmark>Verification with Benchmark</a></li><li><a href=#comparing-with-synchronous-ping-sweep>Comparing with Synchronous Ping Sweep</a></li></ul></li></ul></li><li><a href=#closing-thoughts>Closing Thoughts</a></li></ul></nav></summary></details><div class="blog-content page-content"><p>As a mechatronics engineer (in training), sometimes I like to pretend that I also know how to program.</p><p>In my most recent adventures to software land at <a href=https://mistywest.com/>MistyWest</a>, I needed to write an application in C# that involved doing a ping sweep to find devices that were physically connected through ethernet. Since Google and Stack Overflow are my two best friends, I was able to find (what seemed to be) an off-the-net solution quite quickly.</p><p>However, despite this being a relatively well known objective with well-known libraries to accomplish it, my journey to developing a solution was not as easy as I originally thought. The following post outlines the things I tried before arriving to a working solution, which hopefully is at least mildly interesting and/or educational. Also if you&rsquo;re a software engineer reading this, please go easy on my code. Or not.</p><h1 id=the-development class=anchor><a href=#the-development>The Development</a></h1><h2 id=first-attempt-some-ping-simple class=anchor><a href=#first-attempt-some-ping-simple>First Attempt: Some-ping Simple</a></h2><p>A quick Google search showed that pinging addresses is dead easy in C#. Using the <code>System.Net.NetworkInformation</code> namespace, we can easily use the <code>Ping.Send()</code> command to check if a remote address is alive.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c# data-lang=c#><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Net.NetworkInformation</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>timeout</span> <span class=p>=</span> <span class=m>10</span><span class=p>;</span>   <span class=c1>//in ms</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Ping</span> <span class=n>p</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Ping</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>PingReply</span> <span class=n>rep</span> <span class=p>=</span> <span class=n>p</span><span class=p>.</span><span class=n>Send</span><span class=p>(</span><span class=s>&#34;192.168.1.1&#34;</span><span class=p>,</span> <span class=n>timeout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>rep</span><span class=p>.</span><span class=n>Status</span> <span class=p>==</span> <span class=n>IPStatus</span><span class=p>.</span><span class=n>Success</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//host is active</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This is great if we only had a few addresses to ping, because unfortunately this method is unacceptably slow for a user waiting to see if any devices are found. Although <code>Ping.Send</code> has an overload to accept a timeout interval, it appears that setting very low values doesn&rsquo;t actually change much. From the <a href=https://msdn.microsoft.com/en-us/library/ms144955.aspx>MSDN docs</a>:</p><blockquote><p>When specifying very small numbers for timeout, the Ping reply can be received even if timeout milliseconds have elapsed.</p></blockquote><p>In practice, it seems that ~500ms is about the fastest threshold that can be set. Unfortunately, scanning 255 IP addresses this way will be excruciatingly slow (for both the developer and end user). And the search continues&mldr;</p><h2 id=second-attempt-jaime-lan-nister-pingslayer class=anchor><a href=#second-attempt-jaime-lan-nister-pingslayer>Second Attempt: Jaime LAN-nister, Pingslayer</a></h2><p>A few more Googles later and I had what seemed to be the golden solution.</p><p>Thanks to <a href=https://stackoverflow.com/a/4042887>Tim Coker</a>, I thought I was mostly done my application already (knowledge is half the battle, right?). His console application worked wonderfully and was written in C#, which was great news since I was developing the application using Windows Forms. Instead of using the synchronous <code>Ping.Send()</code>, it harnessed the asynchronous <code>Ping.SendAsync()</code> along with the <code>CountdownEvent</code> class in <code>System.Threading</code>. However, upon copying the code into Windows Forms, it didn&rsquo;t seem to work. What gives?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=cm>/* Source: https://stackoverflow.com/a/4042887
</span></span></span><span class=line><span class=cl><span class=cm> * Original author: Tim Coker
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Diagnostics</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Threading</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Net.NetworkInformation</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>ConsoleApplication1</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Program</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>static</span> <span class=n>CountdownEvent</span> <span class=n>countdown</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>static</span> <span class=kt>int</span> <span class=n>upCount</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>static</span> <span class=kt>object</span> <span class=n>lockObj</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>object</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=kd>const</span> <span class=kt>bool</span> <span class=n>resolveNames</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>(</span><span class=kt>string</span><span class=p>[]</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>countdown</span> <span class=p>=</span> <span class=k>new</span> <span class=n>CountdownEvent</span><span class=p>(</span><span class=m>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Stopwatch</span> <span class=n>sw</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Stopwatch</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=n>sw</span><span class=p>.</span><span class=n>Start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=kt>string</span> <span class=n>ipBase</span> <span class=p>=</span> <span class=s>&#34;10.22.4.&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>255</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>string</span> <span class=n>ip</span> <span class=p>=</span> <span class=n>ipBase</span> <span class=p>+</span> <span class=n>i</span><span class=p>.</span><span class=n>ToString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>Ping</span> <span class=n>p</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Ping</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=p>.</span><span class=n>PingCompleted</span> <span class=p>+=</span> <span class=k>new</span> <span class=n>PingCompletedEventHandler</span><span class=p>(</span><span class=n>p_PingCompleted</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>countdown</span><span class=p>.</span><span class=n>AddCount</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=p>.</span><span class=n>SendAsync</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=m>100</span><span class=p>,</span> <span class=n>ip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>countdown</span><span class=p>.</span><span class=n>Signal</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=n>countdown</span><span class=p>.</span><span class=n>Wait</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=n>sw</span><span class=p>.</span><span class=n>Stop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=n>TimeSpan</span> <span class=n>span</span> <span class=p>=</span> <span class=k>new</span> <span class=n>TimeSpan</span><span class=p>(</span><span class=n>sw</span><span class=p>.</span><span class=n>ElapsedTicks</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;Took {0} milliseconds. {1} hosts active.&#34;</span><span class=p>,</span> <span class=n>sw</span><span class=p>.</span><span class=n>ElapsedMilliseconds</span><span class=p>,</span> <span class=n>upCount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>ReadLine</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>static</span> <span class=k>void</span> <span class=n>p_PingCompleted</span><span class=p>(</span><span class=kt>object</span> <span class=n>sender</span><span class=p>,</span> <span class=n>PingCompletedEventArgs</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>string</span> <span class=n>ip</span> <span class=p>=</span> <span class=p>(</span><span class=kt>string</span><span class=p>)</span><span class=n>e</span><span class=p>.</span><span class=n>UserState</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=n>Reply</span> <span class=p>!=</span> <span class=kc>null</span> <span class=p>&amp;&amp;</span> <span class=n>e</span><span class=p>.</span><span class=n>Reply</span><span class=p>.</span><span class=n>Status</span> <span class=p>==</span> <span class=n>IPStatus</span><span class=p>.</span><span class=n>Success</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;{0} is up: ({1} ms)&#34;</span><span class=p>,</span> <span class=n>ip</span><span class=p>,</span> <span class=n>e</span><span class=p>.</span><span class=n>Reply</span><span class=p>.</span><span class=n>RoundtripTime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>lock</span><span class=p>(</span><span class=n>lockObj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>upCount</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=n>Reply</span> <span class=p>==</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;Pinging {0} failed. (Null Reply object?)&#34;</span><span class=p>,</span> <span class=n>ip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>countdown</span><span class=p>.</span><span class=n>Signal</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Lesson learned: Console applications and Windows Forms are different beasts and deadlocks occur with the above code. According to <a href=https://stackoverflow.com/a/7767632>Hans Passant from another Stack Overflow thread</a>, the additional UI thread is the culprit:</p><blockquote><p>Winforms has a synchronization provider whereas console apps do not. The problem is that the <code>Ping</code> class makes a best effort to raise the <code>PingCompleted</code> event on the same thread that calls <code>SendAsync()</code>. So it tries to raise the event on the main thread, but that can&rsquo;t work since the main thread is blocked with the <code>countdown.Wait()</code> call. In a console app however, the <code>PingCompleted</code> event will be raised on a <code>ThreadPool</code> thread.</p></blockquote><p>Hm, turns out this problem wasn&rsquo;t as easy as copying and pasting random code off the internet. Time for a bit of research!</p><h3 id=digging-deeper-a-battle-of-asynchronous-pings class=anchor><a href=#digging-deeper-a-battle-of-asynchronous-pings>Digging Deeper: A Battle of Asynchronous Pings</a></h3><p>For some reason that can only be to confuse inexperienced programmers like myself, there are two different asynchronous ping methods in this class. First on the list:</p><blockquote><p><code>Ping.SendAsync()</code>: <strong>Asynchronously attempts</strong> to send an Internet Control Message Protocol (ICMP) echo message to a computer, and receive a corresponding ICMP echo reply message from that computer. - <a href="https://msdn.microsoft.com/en-us/library/system.net.networkinformation.ping.sendasync(v=vs.110).aspx">MSDN</a></p></blockquote><p>And the second:</p><blockquote><p><code>Ping.SendPingAsync()</code>: Sends an Internet Control Message Protocol (ICMP) echo message to a computer, and receives a corresponding ICMP echo reply message from that computer <strong>as an asynchronous operation</strong>. - <a href="https://msdn.microsoft.com/en-us/library/system.net.networkinformation.ping.sendpingasync(v=vs.110).aspx">MSDN</a></p></blockquote><p>Based on these method descriptions, it appears that <code>SendAsync()</code> does not guarantee asynchronous operation. Since we just learned how threading in console applications vs windows forms is dealt with differently, this may be why it didn&rsquo;t work as expected in the latter case. What we want are guaranteed asynchronous operations, so hopefully <code>SendPingAsync()</code> should perform to its name.</p><p>(One can only assume this second method was added after-the-fact when Microsoft realized that developers wanted a truly asynchronous ping&mldr;)</p><p><strong>The takeaway:</strong> Use <code>SendPingAsync()</code> or bust.</p><h3 id=digging-deeper-background-worker-vs-asyncawait class=anchor><a href=#digging-deeper-background-worker-vs-asyncawait>Digging Deeper: Background Worker vs Async/Await</a></h3><p>So we&rsquo;ve selected our asynchronous ping method, but that still leaves us hanging over how we&rsquo;re going to handle it in a background task. Before .NET 4.0 was released, <code>BackgroundWorker</code> was the de-facto standard<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. However:</p><blockquote><p>The core problem that <code>BackgroundWorker</code> originally solved was the need to <em>execute synchronous code on a background thread</em>. If you&rsquo;re using it for asynchronous or parallel work, you&rsquo;re not using the right tool in the first place. - <a href=http://blog.stephencleary.com/2013/05/taskrun-vs-backgroundworker-round-1.html>Stephen Cleary</a></p></blockquote><p>After .NET 4.0, we have the following options:</p><ul><li>Tasks (Async Methods)</li><li>Tasks (Task Parallel Library)</li><li>Delegate.BeginInvoke</li><li>ThreadPool.QueueUserWorkItem</li><li>Threads</li></ul><p>Discussing each of these methods is beyond the scope of this post, but you can read more on Cleary&rsquo;s article on <a href=http://blog.stephencleary.com/2010/08/various-implementations-of-asynchronous.html>various implementations of asynchronous background tasks</a>. In short, using <code>Task</code>-returning asynchronous methods is the best overall method to use.</p><p>Kind of.</p><p>For my application, sending each ping to its own task using <code>async/await</code> is logical, as I could then call <code>Task.WhenAll()</code> to wait until all pings have been received back to the main thread.</p><p>However, I could still use <code>BackgroundWorker</code> for SFTP file transfer from the remote devices to a local directory (required in my final application, but not included in this ping sweep demo). Doing so would prevent the main UI thread from hanging while files are being transferred. Although <code>async/await</code> may also be used for this, <code>BackgroundWorker</code> seemed to be the more appropriate (and easier) implementation since each file is serially transferred from remote to local device. Additionally, it&rsquo;s just drag and drop in WinForms!</p><p><strong>The takeaway:</strong> Use <code>async/await</code> for asynchronous ping sweep, and <code>BackgroundWorker</code> for SFTP file transfers.</p><h2 id=third-attempt-one-ping-to-rule-them-all-one-ping-to-find-them class=anchor><a href=#third-attempt-one-ping-to-rule-them-all-one-ping-to-find-them>Third Attempt: One Ping to Rule Them All, One Ping to Find Them</a></h2><p>Finally, we have a working solution! Using <code>async/await</code> with <code>Tasks</code> in <code>System.Threading.Tasks</code> yields promising results. See below for the implementation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c# data-lang=c#><span class=line><span class=cl><span class=kd>private</span> <span class=kt>string</span> <span class=n>BaseIP</span> <span class=p>=</span> <span class=s>&#34;192.168.1.&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>StartIP</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>StopIP</span> <span class=p>=</span> <span class=m>255</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>string</span> <span class=n>ip</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>timeout</span> <span class=p>=</span> <span class=m>100</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>nFound</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>static</span> <span class=kt>object</span> <span class=n>lockObj</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>object</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Stopwatch</span> <span class=n>stopWatch</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Stopwatch</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>TimeSpan</span> <span class=n>ts</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>async</span> <span class=k>void</span> <span class=n>RunPingSweep_Async</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>nFound</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>tasks</span> <span class=p>=</span> <span class=k>new</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Task</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>stopWatch</span><span class=p>.</span><span class=n>Start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=n>StartIP</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;=</span> <span class=n>StopIP</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ip</span> <span class=p>=</span> <span class=n>BaseIP</span> <span class=p>+</span> <span class=n>i</span><span class=p>.</span><span class=n>ToString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=p>.</span><span class=n>Net</span><span class=p>.</span><span class=n>NetworkInformation</span><span class=p>.</span><span class=n>Ping</span> <span class=n>p</span> <span class=p>=</span> <span class=k>new</span> <span class=n>System</span><span class=p>.</span><span class=n>Net</span><span class=p>.</span><span class=n>NetworkInformation</span><span class=p>.</span><span class=n>Ping</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>task</span> <span class=p>=</span> <span class=n>PingAndUpdateAsync</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>ip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>tasks</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>task</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>Task</span><span class=p>.</span><span class=n>WhenAll</span><span class=p>(</span><span class=n>tasks</span><span class=p>).</span><span class=n>ContinueWith</span><span class=p>(</span><span class=n>t</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>stopWatch</span><span class=p>.</span><span class=n>Stop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ts</span> <span class=p>=</span> <span class=n>stopWatch</span><span class=p>.</span><span class=n>Elapsed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>MessageBox</span><span class=p>.</span><span class=n>Show</span><span class=p>(</span><span class=n>nFound</span><span class=p>.</span><span class=n>ToString</span><span class=p>()</span> <span class=p>+</span> <span class=s>&#34; devices found! Elapsed time: &#34;</span> <span class=p>+</span> <span class=n>ts</span><span class=p>.</span><span class=n>ToString</span><span class=p>(),</span> <span class=s>&#34;Asynchronous&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>async</span> <span class=n>Task</span> <span class=n>PingAndUpdateAsync</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>Net</span><span class=p>.</span><span class=n>NetworkInformation</span><span class=p>.</span><span class=n>Ping</span> <span class=n>ping</span><span class=p>,</span> <span class=kt>string</span> <span class=n>ip</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>reply</span> <span class=p>=</span> <span class=k>await</span> <span class=n>ping</span><span class=p>.</span><span class=n>SendPingAsync</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=n>timeout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>reply</span><span class=p>.</span><span class=n>Status</span> <span class=p>==</span> <span class=n>System</span><span class=p>.</span><span class=n>Net</span><span class=p>.</span><span class=n>NetworkInformation</span><span class=p>.</span><span class=n>IPStatus</span><span class=p>.</span><span class=n>Success</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>lock</span><span class=p>(</span><span class=n>lockObj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>nFound</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>![Asynchronous pings are light years faster! Half a second and we&rsquo;re rocking with all the pings we needed.](ping result - async.png)</p><h3 id=verification-with-benchmark class=anchor><a href=#verification-with-benchmark>Verification with Benchmark</a></h3><p>To make sure our numbers add up, let&rsquo;s compare it with a known tool that is much more mature than this C# application.</p><p><div class="row img-captioned"><a href=/posts/2018/02/ping-sweeper/angryip.PNG><img loading=lazy class="img-responsive img-content" src=/posts/2018/02/ping-sweeper/angryip.PNG></a><p class=caption>Verifying scanned result with Angry IP scanner because apparently nmap isn&rsquo;t fully functional in Windows Subsystem for Linux yet.</p></div></p><p>Same number of hosts alive, but a little slower. However, Angry IP Scanner is more robust in its pings and thread handling, so the few extra seconds is likely put to good use. I found my application to be somewhat inconsistent in finding all the alive hosts, which may be mitigated with multiple ping packets to send (instead of just one).</p><h3 id=comparing-with-synchronous-ping-sweep class=anchor><a href=#comparing-with-synchronous-ping-sweep>Comparing with Synchronous Ping Sweep</a></h3><p>Because pinging is such an interesting past-time, let&rsquo;s see how the very first synchronous solution performs using <code>Ping.Send()</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c# data-lang=c#><span class=line><span class=cl><span class=kd>private</span> <span class=kt>string</span> <span class=n>BaseIP</span> <span class=p>=</span> <span class=s>&#34;192.168.1.&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>StartIP</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>StopIP</span> <span class=p>=</span> <span class=m>255</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>string</span> <span class=n>ip</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>timeout</span> <span class=p>=</span> <span class=m>100</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>nFound</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Stopwatch</span> <span class=n>stopWatch</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Stopwatch</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>TimeSpan</span> <span class=n>ts</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>void</span> <span class=n>RunPingSweep_Sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>nFound</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>stopWatch</span><span class=p>.</span><span class=n>Start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=p>.</span><span class=n>Net</span><span class=p>.</span><span class=n>NetworkInformation</span><span class=p>.</span><span class=n>Ping</span> <span class=n>p</span> <span class=p>=</span> <span class=k>new</span> <span class=n>System</span><span class=p>.</span><span class=n>Net</span><span class=p>.</span><span class=n>NetworkInformation</span><span class=p>.</span><span class=n>Ping</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=n>StartIP</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;=</span> <span class=n>StopIP</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ip</span> <span class=p>=</span> <span class=n>BaseIP</span> <span class=p>+</span> <span class=n>i</span><span class=p>.</span><span class=n>ToString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=p>.</span><span class=n>Net</span><span class=p>.</span><span class=n>NetworkInformation</span><span class=p>.</span><span class=n>PingReply</span> <span class=n>rep</span> <span class=p>=</span> <span class=n>p</span><span class=p>.</span><span class=n>Send</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=n>timeout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>rep</span><span class=p>.</span><span class=n>Status</span> <span class=p>==</span> <span class=n>System</span><span class=p>.</span><span class=n>Net</span><span class=p>.</span><span class=n>NetworkInformation</span><span class=p>.</span><span class=n>IPStatus</span><span class=p>.</span><span class=n>Success</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>nFound</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>stopWatch</span><span class=p>.</span><span class=n>Stop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ts</span> <span class=p>=</span> <span class=n>stopWatch</span><span class=p>.</span><span class=n>Elapsed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>MessageBox</span><span class=p>.</span><span class=n>Show</span><span class=p>(</span><span class=n>nFound</span><span class=p>.</span><span class=n>ToString</span><span class=p>()</span> <span class=p>+</span> <span class=s>&#34; devices found! Elapsed time: &#34;</span> <span class=p>+</span> <span class=n>ts</span><span class=p>.</span><span class=n>ToString</span><span class=p>(),</span> <span class=s>&#34;Synchronous&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>![Result of 255 pings using a synchronous method. Nobody has 2 minutes to wait for a complete scan.](ping result - sync.png)</p><p>Wow. A full two minutes compared to less than one second. Life truly is better when you live asynchronously.</p><h1 id=closing-thoughts class=anchor><a href=#closing-thoughts>Closing Thoughts</a></h1><p>This concludes another adventure through asynchronous methods in C#. It&rsquo;s amazing how much information is available on the internet, and I truly would not be able to get this far without it. Google and Stack Overflow, what would I be without you?</p><p>Thanks for reading, and I hope you learned a <em>ping</em> or two about these methods.</p><br><p>Check out the full source code of this project on <a href=https://github.com/justinmklam/ping-sweeper/blob/master/Ping%20Sweep%20Demo/Ping%20Sweep%20Demo/FormMain.cs>Github</a>!</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>According to <a href=http://blog.stephencleary.com/2010/08/various-implementations-of-asynchronous.html>Stephen Cleary</a>, one of <a href="https://mvp.microsoft.com/en-us/PublicProfile/5000058?fullName=Stephen%20Cleary">Microsoft&rsquo;s Most Valuable Professionals</a> and top answerer for async/await questions on Stack Overflow. I&rsquo;d trust him if I were you.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=nav-btn><a href=/>&lt; Recent Posts</a></div><hr><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="justinmklam",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><div style=text-align:center><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>Comments powered by Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>Comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><script defer id=dsq-count-scr src=//justinmklam.disqus.com/count.js async></script></body><footer><div class=footer-container><hr><p>&copy; 2025 Justin Lam | <a href=/colophon>Colophon</a></p></div></footer></html>