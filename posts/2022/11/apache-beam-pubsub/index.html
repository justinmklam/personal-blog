<!doctype html><html lang=en><head><title>Using Google Cloud Pubsub for Batch Pipelines in Apache Beam</title>
<meta property="og:image" content="https://justinmklam.com/"><meta property="og:type" content="blog"><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=author content="Justin Lam"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Fira+Mono:wght@400;500;700&family=Fira+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Roboto+Slab:wght@100..900&display=swap" rel=stylesheet><link rel=stylesheet href=/css/neat.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/css/syntax.css media=screen><link rel=stylesheet href=/css/syntax-dark.css media="screen and (prefers-color-scheme: dark)"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-85178257-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-85178257-1")</script></head><body><div class=navbar><span class=navbar-brand>Justin Lam
</span>/ <a href=/>Blog</a>
/ <a href=/archives/>Archives</a>
/ <a href=/about/>About</a>
/ <a href=/contact/>Contact</a></div><div><div class=single-content><h2 data-toc-skip class=blog-title>Using Google Cloud Pubsub for Batch Pipelines in Apache Beam</h2><p class=blog-title-metadata>Posted on November 23, 2022
<em>&nbsp;&#183;&nbsp;3 min read
&nbsp;&#183;&nbsp;
<span class=disqus-comment-count data-disqus-url=https://justinmklam.com/posts/2022/11/apache-beam-pubsub/#disqus_thread># comments</span>
&nbsp;&#183;&nbsp;
<a class=blog-tag href=/tags/today-i-learned>#today-i-learned&nbsp;</a>
<a class=blog-tag href=/tags/programming>#programming&nbsp;</a></em></p><div class="blog-content page-content"><p>Google Cloud&rsquo;s <a href=https://cloud.google.com/pubsub/docs/overview>Pub/Sub</a> is a useful service that provides an asynchronous and scalable messaging platform that decouples services producing messages from those that receive and process those messages. When combined with <a href=https://github.com/apache/beam>Apache Beam</a> (and/or <a href=https://cloud.google.com/dataflow/docs/about-dataflow>Dataflow</a>, Google&rsquo;s managed version of it), you can quickly develop powerful batch and streaming pipelines for data-parallel processing.</p><p>However, I recently ran into one slight hiccup - although Apache Beam has a <a href=https://beam.apache.org/releases/pydoc/2.4.0/apache_beam.io.gcp.pubsub.html#module-apache_beam.io.gcp.pubsub>built-in IO connector for pubsub</a>, it only supported streaming pipelines (at the time of development). Fortunately, after a bit of searching, someone else on <a href=https://stackoverflow.com/a/67755184/7543727>Stack Overflow</a> figured out a workable solution:</p><blockquote><p>The trick is that if you call future.result() inside the process() method, you will block until that single message is successfully published, so instead collect a list of futures and then at the end of the bundle make sure they&rsquo;re all either published or definitively timed out. Some quick testing with one of our internal pipelines suggested that this approach can publish 1.6M messages in ~200s.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>apache_beam</span> <span class=k>as</span> <span class=nn>beam</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.io.gcp.pubsub</span> <span class=kn>import</span> <span class=n>PubsubMessage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>google.cloud.pubsub_v1</span> <span class=kn>import</span> <span class=n>PublisherClient</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>google.cloud.pubsub_v1.types</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>BatchSettings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>LimitExceededBehavior</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PublishFlowControl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PublisherOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PublishClient</span><span class=p>(</span><span class=n>PublisherClient</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    You have to override __reduce__ to make PublisherClient pickleable ðŸ˜¡ ðŸ˜¤ ðŸ¤¬
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Props to &#39;Ankur&#39; and &#39;Benjamin&#39; on SO for figuring this part out; god knows
</span></span></span><span class=line><span class=cl><span class=s2>    I would not have...
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>__reduce__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=p>,</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>batch_settings</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>publisher_options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BatchPubsubWriter</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>DoFn</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    beam.io.gcp.pubsub does not yet support batch operations, so
</span></span></span><span class=line><span class=cl><span class=s2>    we do this the hard way.  it&#39;s not as performant as the native
</span></span></span><span class=line><span class=cl><span class=s2>    pubsubio but it does the job.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>topic</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>topic</span> <span class=o>=</span> <span class=n>topic</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>window</span> <span class=o>=</span> <span class=n>beam</span><span class=o>.</span><span class=n>window</span><span class=o>.</span><span class=n>GlobalWindow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>batch_settings</span> <span class=o>=</span> <span class=n>BatchSettings</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>max_bytes</span><span class=o>=</span><span class=mf>1e6</span><span class=p>,</span>  <span class=c1># 1MB</span>
</span></span><span class=line><span class=cl>            <span class=c1># by default it is 10 ms, should be less than timeout used in future.result() to avoid timeout</span>
</span></span><span class=line><span class=cl>            <span class=n>max_latency</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>publisher_options</span> <span class=o>=</span> <span class=n>PublisherOptions</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>enable_message_ordering</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=c1># better to be slow than to drop messages during a recovery...</span>
</span></span><span class=line><span class=cl>            <span class=n>flow_control</span><span class=o>=</span><span class=n>PublishFlowControl</span><span class=p>(</span><span class=n>limit_exceeded_behavior</span><span class=o>=</span><span class=n>LimitExceededBehavior</span><span class=o>.</span><span class=n>BLOCK</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>publisher</span> <span class=o>=</span> <span class=n>PublishClient</span><span class=p>(</span><span class=n>batch_settings</span><span class=p>,</span> <span class=n>publisher_options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>start_bundle</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>futures</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>element</span><span class=p>:</span> <span class=n>PubsubMessage</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=n>beam</span><span class=o>.</span><span class=n>DoFn</span><span class=o>.</span><span class=n>WindowParam</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>window</span> <span class=o>=</span> <span class=n>window</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>futures</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>publisher</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>topic</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>topic</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span><span class=o>=</span><span class=n>element</span><span class=o>.</span><span class=n>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=o>**</span><span class=n>element</span><span class=o>.</span><span class=n>attributes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>finish_bundle</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Iterate over the list of async publish results and block
</span></span></span><span class=line><span class=cl><span class=s2>        until all of them have either succeeded or timed out.  Yield
</span></span></span><span class=line><span class=cl><span class=s2>        a WindowedValue of the success/fail counts.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>count</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>count</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>futures</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>fut</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>futures</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># future.result() blocks until success or timeout;</span>
</span></span><span class=line><span class=cl>                <span class=c1># we&#39;ve set a max_latency of 60s upstairs in BatchSettings,</span>
</span></span><span class=line><span class=cl>                <span class=c1># so we should never spend much time waiting here.</span>
</span></span><span class=line><span class=cl>                <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>fut</span><span class=o>.</span><span class=n>result</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>60</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>ex</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>res_count</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>res</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>res</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>res_count</span><span class=p>[</span><span class=s2>&#34;success&#34;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># if it&#39;s not a string, it&#39;s an exception</span>
</span></span><span class=line><span class=cl>                <span class=n>msg</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>res</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>msg</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>res_count</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>res_count</span><span class=p>[</span><span class=n>msg</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>res_count</span><span class=p>[</span><span class=n>msg</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Pubsub publish results: </span><span class=si>{</span><span class=n>res_count</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>beam</span><span class=o>.</span><span class=n>utils</span><span class=o>.</span><span class=n>windowed_value</span><span class=o>.</span><span class=n>WindowedValue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>value</span><span class=o>=</span><span class=n>res_count</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>windows</span><span class=o>=</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>window</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>teardown</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Published </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>count</span><span class=si>}</span><span class=s2> messages&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>Unfortunately, I eventually ran into an issue where the pubsub client was being overloaded when processing large amounts of data under specifying conditions. Explicitly batching the data mitigated the issue, instead of letting the (Dataflow) runner auto-magically determining the bundle sizes based on the input data.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>apache_beam</span> <span class=k>as</span> <span class=nn>beam</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This can probably be higher if needed, but works fine as it is</span>
</span></span><span class=line><span class=cl><span class=n>MIN_PUBSUB_BATCH_SIZE</span> <span class=o>=</span> <span class=mi>10000</span>
</span></span><span class=line><span class=cl><span class=c1># Have tested up to 400k, but instability seems to start occurring at these bundle sizes</span>
</span></span><span class=line><span class=cl><span class=n>MAX_PUBSUB_BATCH_SIZE</span> <span class=o>=</span> <span class=mi>200000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>beam</span><span class=o>.</span><span class=n>Pipeline</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=n>pipeline_options</span><span class=p>)</span> <span class=k>as</span> <span class=n>pipeline</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>pipeline</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=s2>&#34;Batch Messages for Pubsub&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>transforms</span><span class=o>.</span><span class=n>util</span><span class=o>.</span><span class=n>BatchElements</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>min_batch_size</span><span class=o>=</span><span class=n>MIN_PUBSUB_BATCH_SIZE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_batch_size</span><span class=o>=</span><span class=n>MAX_PUBSUB_BATCH_SIZE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=s2>&#34;Publish Batches to PubSub&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>BatchPubsubWriter</span><span class=p>(</span><span class=s2>&#34;projects/myproject/topics/my-topic&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></div><p>Hopefully Apache Beam eventually adds official support for pubsub in batch pipelines, but until then, this seems to suffice for processing millions of rows of data per job.</p></div><div class=nav-btn><a href=/>&lt; Recent Posts</a></div><hr><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="justinmklam",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><div style=text-align:center><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>Comments powered by Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>Comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script defer id=dsq-count-scr src=//justinmklam.disqus.com/count.js async></script></body><footer><div class=footer-container><hr><p>&copy; 2025 Justin Lam | <a href=/colophon>Colophon</a></p></div></footer></html>