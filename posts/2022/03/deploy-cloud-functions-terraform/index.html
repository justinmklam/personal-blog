<!doctype html><html lang=en><head><title>Deploying Google Cloud Functions with Terraform</title>
<meta property="og:image" content="https://justinmklam.com/"><meta property="og:type" content="blog"><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=author content="Justin Lam"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Fira+Mono:wght@400;500;700&family=Fira+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Roboto+Slab:wght@100..900&display=swap" rel=stylesheet><link rel=stylesheet href=/css/neat.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/css/syntax.css media=screen><link rel=stylesheet href=/css/syntax-dark.css media="screen and (prefers-color-scheme: dark)"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-85178257-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-85178257-1")</script></head><body><div class=navbar><span class=navbar-brand>Justin Lam
</span>/ <a href=/>Blog</a>
/ <a href=/archives/>Archives</a>
/ <a href=/about/>About</a>
/ <a href=/contact/>Contact</a></div><div><div class=single-content><h2 data-toc-skip class=blog-title>Deploying Google Cloud Functions with Terraform</h2><p class=blog-title-metadata>Posted on March 8, 2022
<em>&nbsp;&#183;&nbsp;3 min read
&nbsp;&#183;&nbsp;
<span class=disqus-comment-count data-disqus-url=https://justinmklam.com/posts/2022/03/deploy-cloud-functions-terraform/#disqus_thread># comments</span>
&nbsp;&#183;&nbsp;
<a class=blog-tag href=/tags/today-i-learned>#today-i-learned&nbsp;</a>
<a class=blog-tag href=/tags/programming>#programming&nbsp;</a></em></p><div class="blog-content page-content"><p>Cloud Functions are an easy, performant, and potentially inexpensive way to build serverless backends. I recently went down the route of setting up continuous deployments for them, and thought I&rsquo;d share my learnings with it.</p><p>The easiest way to deploy a Cloud Function is using the <code>gcloud</code> CLI like so:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>gcloud functions deploy &lt;YOUR_FUNCTION_NAME&gt; <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --region<span class=o>=</span>&lt;YOUR_REGION&gt; <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --runtime<span class=o>=</span>&lt;YOUR_RUNTIME&gt; <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --source<span class=o>=</span>&lt;YOUR_SOURCE_LOCATION&gt; <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --entry-point<span class=o>=</span>&lt;YOUR_CODE_ENTRYPOINT&gt; <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  &lt;TRIGGER_FLAGS&gt;
</span></span></code></pre></div><p>Things get a bit more complicated if you want to use Terraform for deployments, which has its own set of advantages. The main trick to getting it to work is in line 43 below, where a checksum is appended to the archive&rsquo;s filename every time it&rsquo;s uploaded to the storage bucket.</p><p>The reason this is necessary is because the <code>google_cloudfunctions_function</code> resource won&rsquo;t be triggered for a redeployment on subsequent code changes - by having a checksum generated based on the source code, we ensure that Terraform knows to redeploy the Cloud Function whenever the underlying code changes.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=ln> 1</span><span class=cl><span class=k>locals</span> {
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=n>  project_id</span> <span class=o>=</span> <span class=s2>&#34;my-project&#34;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=n>  region</span>     <span class=o>=</span> <span class=s2>&#34;us-west1&#34;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=n>  component</span>  <span class=o>=</span> <span class=s2>&#34;my-component&#34;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=n>  cloud_function</span> <span class=o>=</span> {
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=n>    name</span>        <span class=o>=</span> <span class=s2>&#34;${local.component}-cf&#34;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=n>    description</span> <span class=o>=</span> <span class=s2>&#34;Some description for this cloud function&#34;</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=n>    runtime</span>     <span class=o>=</span> <span class=s2>&#34;python39&#34;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=n>    entry_point</span> <span class=o>=</span> <span class=s2>&#34;my_entry_point&#34;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=n>    source_dir</span>       <span class=o>=</span> <span class=s2>&#34;./src&#34;</span>
</span></span><span class=line><span class=ln>13</span><span class=cl><span class=n>    archive_filepath</span> <span class=o>=</span> <span class=s2>&#34;/path/to/file&#34;</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>  }
</span></span><span class=line><span class=ln>15</span><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=c1>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=c1># Service account for the Cloud Function
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;google_service_account&#34; &#34;cloud_function_sa&#34;</span> {
</span></span><span class=line><span class=ln>19</span><span class=cl><span class=n>  project</span>      <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=ln>20</span><span class=cl><span class=n>  account_id</span>   <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>component</span>
</span></span><span class=line><span class=ln>21</span><span class=cl><span class=n>  display_name</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>component</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=c1>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=c1># Bucket to store the source code archives
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;google_storage_bucket&#34; &#34;function_archive&#34;</span> {
</span></span><span class=line><span class=ln>26</span><span class=cl><span class=n>    name</span>     <span class=o>=</span> <span class=s2>&#34;${local.component}-cloud-function-archive&#34;</span>
</span></span><span class=line><span class=ln>27</span><span class=cl><span class=n>    location</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>region</span>
</span></span><span class=line><span class=ln>28</span><span class=cl><span class=n>    project</span>  <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=ln>29</span><span class=cl><span class=n>    uniform_bucket_level_access</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=c1>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=c1># Archive the source code as a zip file
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=c1></span><span class=k>data</span> <span class=s2>&#34;archive_file&#34; &#34;function_archive&#34;</span> {
</span></span><span class=line><span class=ln>34</span><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=s2>&#34;zip&#34;</span>
</span></span><span class=line><span class=ln>35</span><span class=cl><span class=n>  source_dir</span>  <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>cloud_functions</span><span class=p>.</span><span class=k>source_dir</span>
</span></span><span class=line><span class=ln>36</span><span class=cl><span class=n>  output_path</span> <span class=o>=</span> <span class=s2>&#34;${path.root}/${local.cloud_function.archive_filepath}&#34;</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=c1>
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=c1># Upload the source code archive to the bucket. This will happen each time
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=c1># the source code changes.
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;google_storage_bucket_object&#34; &#34;archive&#34;</span> {<span class=c1>
</span></span></span><span class=line><span class=ln>42</span><span class=cl><span class=c1>  # Append checksum so file changes trigger a cloud function deployment
</span></span></span><span class="line hl"><span class=ln>43</span><span class=cl><span class=c1></span><span class=n>  name</span>   <span class=o>=</span> <span class=k>format</span><span class=p>(</span>
</span></span><span class="line hl"><span class=ln>44</span><span class=cl>            <span class=s2>&#34;%s#%s&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=ln>45</span><span class=cl>            <span class=k>local</span><span class=p>.</span><span class=k>cloud_function</span><span class=p>.</span><span class=k>archive_filepath</span><span class=p>,</span>
</span></span><span class="line hl"><span class=ln>46</span><span class=cl>            <span class=k>data</span><span class=p>.</span><span class=k>archive_file</span><span class=p>.</span><span class=k>function_archive</span><span class=p>.</span><span class=k>output_md5</span>
</span></span><span class="line hl"><span class=ln>47</span><span class=cl>          <span class=p>)</span>
</span></span><span class=line><span class=ln>48</span><span class=cl><span class=n>  bucket</span> <span class=o>=</span> <span class=k>google_storage_bucket</span><span class=p>.</span><span class=k>function_archive</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=ln>49</span><span class=cl><span class=n>  source</span> <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>archive_file</span><span class=p>.</span><span class=k>function_archive</span><span class=p>.</span><span class=k>output_path</span>
</span></span><span class=line><span class=ln>50</span><span class=cl>
</span></span><span class=line><span class=ln>51</span><span class=cl><span class=n>  content_disposition</span> <span class=o>=</span> <span class=s2>&#34;attachment&#34;</span>
</span></span><span class=line><span class=ln>52</span><span class=cl><span class=n>  content_encoding</span>    <span class=o>=</span> <span class=s2>&#34;gzip&#34;</span>
</span></span><span class=line><span class=ln>53</span><span class=cl><span class=n>  content_type</span>        <span class=o>=</span> <span class=s2>&#34;application/zip&#34;</span>
</span></span><span class=line><span class=ln>54</span><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=ln>55</span><span class=cl><span class=c1>
</span></span></span><span class=line><span class=ln>56</span><span class=cl><span class=c1># Cloud Function that uses the uploaded source code archive
</span></span></span><span class=line><span class=ln>57</span><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;google_cloudfunctions_function&#34; &#34;some_cloud_function&#34;</span> {
</span></span><span class=line><span class=ln>58</span><span class=cl><span class=n>  name</span>        <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>cloud_function</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=ln>59</span><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Some description for my cloud function&#34;</span>
</span></span><span class=line><span class=ln>60</span><span class=cl>
</span></span><span class=line><span class=ln>61</span><span class=cl><span class=n>  project</span>               <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=ln>62</span><span class=cl><span class=n>  region</span>                <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>region</span>
</span></span><span class=line><span class=ln>63</span><span class=cl><span class=n>  source_archive_bucket</span> <span class=o>=</span> <span class=k>google_storage_bucket_object</span><span class=p>.</span><span class=k>archive</span><span class=p>.</span><span class=k>bucket</span>
</span></span><span class="line hl"><span class=ln>64</span><span class=cl><span class=n>  source_archive_object</span> <span class=o>=</span> <span class=k>google_storage_bucket_object</span><span class=p>.</span><span class=k>archive</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=ln>65</span><span class=cl><span class=n>  service_account_email</span> <span class=o>=</span> <span class=k>google_service_account</span><span class=p>.</span><span class=k>cloud_function_sa</span><span class=p>.</span><span class=k>email</span>
</span></span><span class=line><span class=ln>66</span><span class=cl>
</span></span><span class=line><span class=ln>67</span><span class=cl><span class=n>  runtime</span>               <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>cloud_function</span><span class=p>.</span><span class=k>runtime</span>
</span></span><span class=line><span class=ln>68</span><span class=cl><span class=n>  entry_point</span>           <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>cloud_function</span><span class=p>.</span><span class=k>entry_point</span>
</span></span><span class=line><span class=ln>69</span><span class=cl><span class=n>  trigger_http</span>          <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=ln>70</span><span class=cl>}
</span></span></code></pre></div></div><div class=nav-btn><a href=/>&lt; Recent Posts</a></div><hr><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="justinmklam",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><div style=text-align:center><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>Comments powered by Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>Comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script defer id=dsq-count-scr src=//justinmklam.disqus.com/count.js async></script></body><footer><div class=footer-container><hr><p>&copy; 2025 Justin Lam | <a href=/colophon>Colophon</a></p></div></footer></html>